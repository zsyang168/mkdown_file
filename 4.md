#  第4章　用Python分析网络流量

## 本章简介

### 定位IP流量的地理位置

### 发现恶意分布式拒绝服务(DDos)工具包

### 发现伪装网络扫描

### 分析风暴(Storm)僵尸网络中使用的Fast-Flux和Conficker蠕虫中使用的Domain-Flux

### 理解TCP序号预测攻击

### 生成数据包愚弄入侵检测系统(IDS)


## 引言　＂极光＂行动以及为什么明显的迹象会被忽视

2010年1月14日，美国政府获悉一起多路协同、老练且持久的网络攻击，攻击目标为谷歌、Adobe及其他30多家世界财富100强企业（Binde, McRee, &O'Connor, 2011)。
在这次被称为“极光”行动（该名称源于一台被黑的计算机上发现的文件夹名字）的攻击中，使用了一个之前从未被使用过的新型漏洞利用代码，尽管微软先前知道这个
系统漏洞，但他们错误地以为没有其他人知道它，因此也就没有要检测类似攻击的机制。

在实施攻击的过程中，攻击者首先会向被攻击者发送一封带有指向台湾某个含有恶意JavaScrip代码的网站链接的电子邮件（Binde, McRee, &O'Connor, 2011)。当用户
单击这个链接时，就会下载一个回到一台位于中国大陆的命令行控制服务器的恶意软件（Zetter, 2010)。之后，攻击者就能利用新获得的访问权限寻找存储在被黑的系
统中他们所关心的信息。

攻击很明显的出现了但在长达数月的时间里却未被检测出来，而是成功的渗透进了许多家世界100强企业的源码仓库，甚至是基本的网络检测软件也能识别这次行为。为
什么一个位于美国的世界100强公司有这么多员工连接上中国台湾的某个特定的网站之后，紧接着又去连接位于中国大陆的某个特定服务器呢？一个可视化的地图显示用
户连接台湾和中国具有显著的频率可以允许网络管理员调查这次攻击，并在相关信息泄露之前切断它。

在下面的内容中，我们运用Python分析多种不同类型的的攻击行为，以便快速解析出使用了大量不同数据点的攻击。

## 4.1 IP流量何去何从？－－用Python回答

### 使用PyGeoIP关联IP地址的物理位置

开源数据库： **GeoLiteCity** [download](https://dev.maxmind.com/geoip/legacy/geolite/#Databases)

python模块:pygeoip **GeoIP**类 [api](https://pygeoip.readthedocs.io/en/v0.3.2/api-reference.html)

- record_by_name(hostname)
- record_by_addr(addr)
- country_code_by_addr(addr)
- country_name_by_addr(addr)
- id_by_addr(addr)
- region_by_addr(addr) （
- time_zone_by_addr(addr)  （时区）
- ...

**record_by_name(hostname)**

- 城市 (city)
- 区域号 (region_code)
- 区号 (area_code)
- 时区(time_zone)
- 经度 (latitude)
- 纬度 (longitude)
- 邮政编码（postal_code)
- 国名(country_name)
- 大陆(continent)
- ...

```C
import pygeoip
gi n pygeoip.GeoIP('/opt/GeoIP/GeoIP.dat')
den printRecord(tgt):
	rec = gi.record_by_name(tgt)
	city = rec['city']
	region = rec['region_name']
	country = rec['country_name']
	long = rec['longitude']
	lat = rec['latitude']
	print('[*] Target: ' + tgt + ' Geo-located. ')
	print('[+] '+str(city)+', '+str(region)+', '+str(country))
	print('[+] Latitude: '+str(lat)+ ', Longitude: '+ str(long))
tgt = '173.255.226.98'
printRecord(tgt)

```

### 使用Dpkt解析包 [api](https://dpkt.readthedocs.io/en/latest/api/index.html)

#### 解包结构
```
pcap = dpkt.pcap.Reader(file)
 |
 |_ [timestamp,packet]

dpkt.ethernet.Ethernet(packet)
	|_ dst_mac
	|_ src_mac
	|_ type
	|_ data
		|_ src_ip
		|_ dst_ip
		|_ p
		|_ ...
		|_ data
			|_ tcp
			|    |_ dst_port
			|    |_ src_port
			|
			|_ udp
				|_ dst_port
				|_ src_port
```

####代码

```C
import dpkt
import socket

def printPcap(pcap):
	for (ts, buf) in pcap:
		try:
			eth = dpkt.ethernet.Ethernet(buf)
			ip = eth.data
			src = socket.inet_ntoa(ip.src)
			dst = socket.inet_ntoa(ip.dst)
			print('[+] Src: ' + src + ' --> Dst: ' + dst)
		except:
			pass

def main():
	f = open('data.pcap')
	pcap = dpkt.pcap.Reader(f)
	printPcap(pcap)

if __name__ == '__main__':
	main()
```

改进：加入一个函数来返回指定IP地址对应的物理地址

```C
gi = pygeoip.GeoIP('/opt/GeoIP/GeoIP.dat')
def retGeoStr(ip):
	try:
		rec = gi.record_by_name(ip)
		city = rec['city']
		country = rec['country_code3']
		if city != '':
			geoLoc = city + ', ' + country
		else:
			geoLoc = country
		return geoLoc
ecept Exception as e:
	return 'Unregistered'
```

### 使用Python画谷歌地图

谷歌地球能在一个专门的界面中显示出一个虚拟地球仪、地图和地理信息。虽然用的是专门的界面，但谷歌地球可以让你很方便地在地球仪上画出指定位置或轨迹。通
过创建一个扩展名为KML的文体文件，用户可以把许多个地理位置标大谷歌地球上。KML文件中是下面规定的XML结构。

```
<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
	<Document>
		<Placemark>
			<name>93.170.52.30</name>
			<Point>
				<coordinates>5.750000,52.500000</coordinates>
			</Point>
		</Placemark>
		<Placemark>
			<name>208.73.210.87</name>
			<Point>
				<coordinates>-122.393300,37.769700</coordinates>
			</Point>
		</Placemark>
	</Document>
</kml>
```

我们有了IP地址和对应的物理位置的经纬度，给已有的脚本加上创建KML文件的功能，就可以通过生成的KML文件IP地址的物理位置在谷歌地球上展示出来。

```
def retKML(ip):
	rec = gi.record_by_name(ip)
	try:
		longitude = rec['longitude']
		latitude = rec['latitude']

		kml =
		('<Placemark>\n'
		'<name>%s</name>\n'
		'<Point>\n'
		'<coordinates>%6f,%6f</coordinates>\n'
		'</Point>\n'
		'</Placemark>\n'
		)
		% (ip,longitude, latitude)

		return kml
	except Exception, e:
		return ''
```

我们可以通过这样一个函数构建表示该IP所对应的物理位置的KML结构，如出现异常（没找到对应的地点），则返回一个空串。
还需根据规定添加所需的KML头和尾。

```
kmlheader = '<?xml version="1.0" encoding="UTF-8"?>\n
			 <kml xmlns="http://www.opengis.net/kml/2.2">\n<Document>\n'

kmlfooter = '</Document>\n</kml>\n'
```

## 4.2 ＂匿名者＂真能匿名吗？分析LOIC流量


## 4.3 H.D.Moore是如何解决五角大楼的麻烦的


## 4.4 ＂风暴＂(Storm)的fast-flux和Conficker的domain-flux


## 4.5 Kevin Mitnick和TCP序列预测


## 4.6 使用Scapy愚弄入侵检测系统


## 本章小结





